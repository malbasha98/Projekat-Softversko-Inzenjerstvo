// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace Kucni_poslovi.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "D:\Projekti-master\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\Projekti-master\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\Projekti-master\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\Projekti-master\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\Projekti-master\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\Projekti-master\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\Projekti-master\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\Projekti-master\_Imports.razor"
using Kucni_poslovi;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\Projekti-master\_Imports.razor"
using Kucni_poslovi.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "D:\Projekti-master\_Imports.razor"
using Kucni_poslovi.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "D:\Projekti-master\_Imports.razor"
using Syncfusion.Blazor.Inputs;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "D:\Projekti-master\_Imports.razor"
using Syncfusion.Blazor.DropDowns;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "D:\Projekti-master\_Imports.razor"
using Microsoft.AspNetCore.Identity;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "D:\Projekti-master\_Imports.razor"
using Syncfusion.Blazor.Popups;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "D:\Projekti-master\_Imports.razor"
using Syncfusion.Blazor.Buttons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "D:\Projekti-master\_Imports.razor"
using Syncfusion.Blazor.SplitButtons;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\Projekti-master\Pages\MojProfil.razor"
using System.Text.RegularExpressions;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\Projekti-master\Pages\MojProfil.razor"
using System.IO;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\Projekti-master\Pages\MojProfil.razor"
using Newtonsoft.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\Projekti-master\Pages\MojProfil.razor"
using System.ComponentModel.DataAnnotations;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/MojProfil")]
    public partial class MojProfil : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 250 "D:\Projekti-master\Pages\MojProfil.razor"
           
        KorisnikUsluge izmenaKorisnik = new KorisnikUsluge();
        PruzalacUsluge izmenaPruzalac = new PruzalacUsluge();
        public bool Ucitan { get; set; } = false;

        private bool VisibilityGlavni { get; set; } = false;
        private bool korisnikUsluge { get; set; }
        private bool Visibility { get; set; } = false;
        private bool AzurirajSliku { get; set; } = false;
        private string slika { get; set; }
        private string prethodnaSlika { get; set; } = "";

        private Sifra NovaSifra = new Sifra();

        protected async override Task OnInitializedAsync()
        {
            Ucitan = false;
            var state = await authenticationStateProvider.GetAuthenticationStateAsync();
            if (state.User.IsInRole("PruzalacUsluge"))
            {
                izmenaPruzalac = await dbContext.VratiPruzaoca(state.User.Identity.Name);
                slika = izmenaPruzalac.PutanjaDoSlike;
                korisnikUsluge = false;
            }
            else if (state.User.IsInRole("KorisnikUsluge"))
            {
                izmenaKorisnik = await dbContext.VratiKorisnika(state.User.Identity.Name);
                slika = izmenaKorisnik.PutanjaDoSlike;
                korisnikUsluge = true;
            }

        }

        protected async override Task OnAfterRenderAsync(bool firstRender)
        {
            if (!firstRender)
            {
                Ucitan = true;
                StateHasChanged();
            }

        }

        private async Task IzmeniProfilKorisnika()
        {
            dbContext.Update(izmenaKorisnik);
            await dbContext.SaveChangesAsync();
            VisibilityGlavni = true;
        }
        private async Task IzmeniProfilPruzaoca()
        {
            dbContext.Update(izmenaPruzalac);
            await dbContext.SaveChangesAsync();
            VisibilityGlavni = true;
        }

        private async Task AzurirajSifru()
        {
            bool rezultat;
            if (korisnikUsluge)
            {
                NovaSifra.userName = izmenaKorisnik.UserName;
                rezultat = await Http.PostJsonAsync<bool>("https://localhost:44341/api/Uploader/ZameniSifru", NovaSifra);

            }
            else
            {
                NovaSifra.userName = izmenaPruzalac.UserName;
                rezultat = await Http.PostJsonAsync<bool>("https://localhost:44341/api/Uploader/ZameniSifru", NovaSifra);
            }
            if (!rezultat)
            {
                NovaSifra.errorZaSifre = "Doslo je do greske proverite ponovo Å¡ifre";
            }
            else
                VisibilityGlavni = true;

        }

        private void OnChange(UploadChangeEventArgs args)
        {
            foreach (var file in args.Files)
            {
                if (slika != "Nema slike.png")
                {
                    if (korisnikUsluge && slika != izmenaKorisnik.PutanjaDoSlike)
                        prethodnaSlika = slika;
                    else if (!korisnikUsluge && slika != izmenaPruzalac.PutanjaDoSlike)
                        prethodnaSlika = slika;
                }

                if (File.Exists(@"wwwroot/" + prethodnaSlika))
                    File.Delete(@"wwwroot/" + prethodnaSlika);

                slika = "KorisnickeSlike/" + Guid.NewGuid().ToString() + file.FileInfo.Name;
                var celaPutanja = @"wwwroot/" + slika;
                FileStream filestream = new FileStream(celaPutanja, FileMode.Create, FileAccess.Write);
                file.Stream.WriteTo(filestream);
                filestream.Close();
                file.Stream.Close();
            }
        }

        private void onRemove(RemovingEventArgs args)
        {
            if (File.Exists(@"wwwroot/" + slika))
            {
                File.Delete(@"wwwroot/" + slika);
                if (korisnikUsluge)
                    slika = izmenaKorisnik.PutanjaDoSlike;
                else
                    slika = izmenaPruzalac.PutanjaDoSlike;
            }

        }

        private void ObrisiSliku()
        {
            if (korisnikUsluge)
            {
                if (izmenaKorisnik.PutanjaDoSlike != "Nema slike.png")
                {
                    if (File.Exists(@"wwwroot/" + izmenaKorisnik.PutanjaDoSlike))
                    {
                        File.Delete(@"wwwroot/" + izmenaKorisnik.PutanjaDoSlike);
                        izmenaKorisnik.PutanjaDoSlike = "Nema slike.png";
                        slika = "Nema slike.png";
                    }
                }
            }
            else
            {
                if (izmenaKorisnik.PutanjaDoSlike != "Nema slike.png")
                {
                    if (File.Exists(@"wwwroot/" + izmenaPruzalac.PutanjaDoSlike))
                    {
                        File.Delete(@"wwwroot/" + izmenaPruzalac.PutanjaDoSlike);
                        izmenaPruzalac.PutanjaDoSlike = "Nema slike.png";
                        slika = "Nema slike.png";
                    }
                }
            }
            this.Visibility = false;
        }

        private async Task SacuvajSliku()
        {
            if (korisnikUsluge)
            {
                if (izmenaKorisnik.PutanjaDoSlike != "Nema slike.png")
                {
                    if (File.Exists(@"wwwroot/" + izmenaKorisnik.PutanjaDoSlike))
                    {
                        File.Delete(@"wwwroot/" + izmenaKorisnik.PutanjaDoSlike);
                    }
                }
                izmenaKorisnik.PutanjaDoSlike = slika;
                dbContext.Update(izmenaKorisnik);
                await dbContext.SaveChangesAsync();
            }
            else
            {
                if (izmenaPruzalac.PutanjaDoSlike != "Nema slike.png")
                {
                    if (File.Exists(@"wwwroot/" + izmenaPruzalac.PutanjaDoSlike))
                    {
                        File.Delete(@"wwwroot/" + izmenaPruzalac.PutanjaDoSlike);
                    }
                }
                izmenaPruzalac.PutanjaDoSlike = slika;
                dbContext.Update(izmenaPruzalac);
                await dbContext.SaveChangesAsync();
            }
            this.VisibilityGlavni = true;
        }

        private void VrtaiNaProfil()
        {
            if (korisnikUsluge)
                navMenager.NavigateTo("Profil/" + izmenaKorisnik.Id, true);
            else
                navMenager.NavigateTo("Profil/" + izmenaPruzalac.Id, true);
        }
    

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private HttpClient Http { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager navMenager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private MySqlCRUD dbContext { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private UserManager<IdentityUser> userManager { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private AuthenticationStateProvider authenticationStateProvider { get; set; }
    }
}
#pragma warning restore 1591
